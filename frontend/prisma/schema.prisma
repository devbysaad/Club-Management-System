// Pato Hornets Club Management System - Production Schema
// Clerk = Authentication | Database = Authorization + Business Logic

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE: AppUser (Source of Truth for Roles)
// ============================================
// Clerk handles authentication, this handles authorization
model AppUser {
  id        String     @id // Clerk userId - DO NOT auto-generate
  email     String     @unique
  role      Role
  status    UserStatus @default(ACTIVE)
  isDeleted Boolean    @default(false)
  deletedAt DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // One user can have ONE role-specific profile
  admin   Admin?
  staff   Staff?
  coach   Coach?
  student Student?
  parent  Parent?

  // Audit trail
  activityLogs ActivityLog[]

  // Shop orders
  jerseyOrders JerseyOrder[]

  @@index([role])
  @@index([status])
  @@index([email])
}

enum Role {
  ADMIN
  STAFF
  COACH
  STUDENT
  PARENT
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
}

// ============================================
// SHARED ENUMS
// ============================================
enum Sex {
  MALE
  FEMALE
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// ============================================
// ROLE-SPECIFIC PROFILES
// ============================================
model Admin {
  id        String    @id @default(uuid())
  userId    String    @unique
  firstName String
  lastName  String
  email     String?
  phone     String?
  photo     String? // URL to Clerk-managed photo
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Staff {
  id        String    @id @default(uuid())
  userId    String    @unique
  firstName String
  lastName  String
  email     String?
  phone     String?
  address   String?
  photo     String? // URL to Clerk-managed photo
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user                  AppUser                @relation(fields: [userId], references: [id], onDelete: Cascade)
  staffDailyAttendance  StaffDailyAttendance[]

  @@index([userId])
  @@map("staff")
}

model Coach {
  id             String    @id @default(uuid())
  userId         String    @unique
  displayId      String?   @unique
  firstName      String
  lastName       String
  email          String?
  phone          String?
  photo          String? // URL to photo storage
  address        String?
  specialization String[]
  sex            Sex
  bloodType      String?
  isDeleted      Boolean   @default(false)
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user            AppUser                @relation(fields: [userId], references: [id], onDelete: Cascade)
  ageGroups       CoachAgeGroup[]
  sessions        TrainingSession[]
  dailyAttendance CoachDailyAttendance[]

  @@index([userId])
  @@index([isDeleted])
}

model Parent {
  id        String    @id @default(uuid())
  userId    String    @unique
  firstName String
  lastName  String
  email     String?
  phone     String?
  address   String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user        AppUser      @relation(fields: [userId], references: [id], onDelete: Cascade)
  students    Student[]
  monthlyFees MonthlyFee[]
  Payment     Payment[]

  @@index([userId])
  @@index([isDeleted])
}

model Student {
  id           String    @id @default(uuid())
  userId       String    @unique
  displayId    String?   @unique
  firstName    String
  lastName     String
  email        String?
  dateOfBirth  DateTime
  photo        String?
  phone        String?
  address      String?
  position     String?
  jerseyNumber Int?
  sex          Sex
  bloodType    String?
  parentId     String
  ageGroupId   String
  isDeleted    Boolean   @default(false)
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user            AppUser           @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent          Parent            @relation(fields: [parentId], references: [id], onDelete: Restrict) // SOFT DELETE
  ageGroup        AgeGroup          @relation(fields: [ageGroupId], references: [id], onDelete: Restrict)
  attendances     Attendance[]
  dailyAttendance DailyAttendance[]
  results         Result[]
  enrollments     Enrollment[]
  orders          Order[]
  monthlyFees     MonthlyFee[]
  feeRecords      PlayerFeeRecord[]

  @@index([userId])
  @@index([parentId])
  @@index([ageGroupId])
  @@index([isDeleted])
}

// ============================================
// AGE GROUPS (Teams)
// ============================================
model AgeGroup {
  id          String    @id @default(uuid())
  name        String    @unique
  minAge      Int
  maxAge      Int
  capacity    Int
  description String?
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  students    Student[]
  sessions    TrainingSession[]
  fixtures    Fixture[]
  coaches     CoachAgeGroup[]
  enrollments Enrollment[]

  @@index([isDeleted])
}

// Join table for Coach <-> AgeGroup (many-to-many)
model CoachAgeGroup {
  id         String   @id @default(uuid())
  coachId    String
  ageGroupId String
  assignedAt DateTime @default(now())

  coach    Coach    @relation(fields: [coachId], references: [id], onDelete: Cascade)
  ageGroup AgeGroup @relation(fields: [ageGroupId], references: [id], onDelete: Cascade)

  @@unique([coachId, ageGroupId])
  @@index([coachId])
  @@index([ageGroupId])
}

// Track student enrollment in age groups over time
model Enrollment {
  id         String    @id @default(uuid())
  studentId  String
  ageGroupId String
  enrolledAt DateTime  @default(now())
  exitedAt   DateTime?
  isActive   Boolean   @default(true)

  student  Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  ageGroup AgeGroup @relation(fields: [ageGroupId], references: [id], onDelete: Restrict)

  @@index([studentId])
  @@index([ageGroupId])
  @@index([isActive])
}

// ============================================
// TRAINING SESSIONS
// ============================================
model TrainingSession {
  id          String              @id @default(uuid())
  title       String
  description String?
  date        DateTime
  startTime   DateTime
  endTime     DateTime
  dayOfWeek   DayOfWeek
  venue       String
  type        TrainingSessionType
  coachId     String // OWNERSHIP: Coach can only edit their own
  ageGroupId  String
  isDeleted   Boolean             @default(false)
  deletedAt   DateTime?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  coach       Coach        @relation(fields: [coachId], references: [id], onDelete: Restrict)
  ageGroup    AgeGroup     @relation(fields: [ageGroupId], references: [id], onDelete: Restrict)
  attendances Attendance[]

  @@index([coachId])
  @@index([ageGroupId])
  @@index([date])
  @@index([isDeleted])
}

enum TrainingSessionType {
  TRAINING
  MATCH
  FRIENDLY
  TOURNAMENT
  FITNESS
  RECOVERY
}

// ============================================
// ATTENDANCE
// ============================================
model Attendance {
  id                String           @id @default(uuid())
  studentId         String
  trainingSessionId String
  status            AttendanceStatus
  notes             String?
  markedAt          DateTime         @default(now())
  markedBy          String // Clerk userId of coach
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  student         Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  trainingSession TrainingSession @relation(fields: [trainingSessionId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([trainingSessionId])
  @@index([markedBy])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

// ============================================
// DAILY ATTENDANCE (Simple Student Attendance)
// ============================================
model DailyAttendance {
  id        String                @id @default(uuid())
  studentId String
  date      DateTime // Date only (time set to midnight)
  status    DailyAttendanceStatus
  markedBy  String // Admin who marked it
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
  @@index([studentId])
  @@index([date])
}

enum DailyAttendanceStatus {
  PRESENT
  ABSENT
}

// ============================================
// DAILY COACH ATTENDANCE
// ============================================
model CoachDailyAttendance {
  id        String                @id @default(uuid())
  coachId   String
  date      DateTime // Date only (time set to midnight)
  status    DailyAttendanceStatus
  markedBy  String // Admin who marked it
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  coach Coach @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@unique([coachId, date])
  @@index([coachId])
  @@index([date])
}

model StaffDailyAttendance {
  id        String                @id @default(uuid())
  staffId   String
  date      DateTime // Date only (time set to midnight)
  status    DailyAttendanceStatus
  markedBy  String // Admin who marked it
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  staff Staff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, date])
  @@index([staffId])
  @@index([date])
}

// ============================================
// FIXTURES & RESULTS
// ============================================
model Fixture {
  id           String      @id @default(uuid())
  title        String
  opponent     String
  date         DateTime
  time         DateTime
  venue        String
  isHome       Boolean
  type         FixtureType
  isCompleted  Boolean     @default(false)
  goalsFor     Int         @default(0)
  goalsAgainst Int         @default(0)
  ageGroupId   String
  isDeleted    Boolean     @default(false)
  deletedAt    DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  ageGroup AgeGroup @relation(fields: [ageGroupId], references: [id], onDelete: Restrict)
  results  Result[]

  @@index([ageGroupId])
  @@index([date])
  @@index([isDeleted])
}

enum FixtureType {
  LEAGUE
  CUP
  FRIENDLY
  TOURNAMENT
}

model Result {
  id            String   @id @default(uuid())
  studentId     String
  fixtureId     String
  goals         Int      @default(0)
  assists       Int      @default(0)
  rating        Float    @default(0)
  minutesPlayed Int      @default(0)
  yellowCards   Int      @default(0)
  redCards      Int      @default(0)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  fixture Fixture @relation(fields: [fixtureId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([fixtureId])
}

// ============================================
// EVENTS
// ============================================
model Event {
  id          String    @id @default(uuid())
  title       String
  description String?
  date        DateTime
  startTime   DateTime
  endTime     DateTime
  venue       String
  type        EventType
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([date])
  @@index([isDeleted])
}

enum EventType {
  TOURNAMENT
  CELEBRATION
  MEETING
  TRIAL
  FUNDRAISER
  OTHER
}

// ============================================
// ANNOUNCEMENTS
// ============================================
model Announcement {
  id          String    @id @default(uuid())
  title       String
  content     String
  priority    Int       @default(1)
  targetRoles Role[]
  publishedAt DateTime  @default(now())
  expiresAt   DateTime?
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([publishedAt])
  @@index([expiresAt])
  @@index([isDeleted])
}

// ============================================
// SHOP: Products & Orders
// ============================================
model Product {
  id          String          @id @default(uuid())
  name        String
  description String?
  price       Float
  category    ProductCategory
  sizes       String[] // ["S", "M", "L", "XL"]
  stock       Int             @default(0)
  images      String[] // URLs to image storage
  isActive    Boolean         @default(true)
  isDeleted   Boolean         @default(false)
  deletedAt   DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  createdBy   String // Admin userId

  orderItems OrderItem[]

  @@index([category])
  @@index([isActive])
  @@index([isDeleted])
}

enum ProductCategory {
  JERSEY
  SHORTS
  SOCKS
  TRAINING_KIT
  ACCESSORIES
  OTHER
}

model Order {
  id              String  @id @default(cuid())
  userId          String // Student or Parent userId
  customerName    String
  contactNumber   String
  email           String
  shippingAddress String?
  totalAmount     Float?

  // Jersey-specific fields
  shirtSize    String?
  shortsSize   String?
  socksSize    String?
  jerseyName   String?
  jerseyNumber Int?
  customLength String?
  customWidth  String?
  customNotes  String?

  status    OrderStatus @default(PENDING)
  notes     String?
  isDeleted Boolean     @default(false) // SOFT DELETE - financial data
  deletedAt DateTime?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  student  Student?    @relation(fields: [userId], references: [userId], onDelete: Restrict)
  items    OrderItem[]
  payments Payment[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([isDeleted])
}

enum OrderStatus {
  PENDING
  PROCESSING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  size      String
  price     Float // Snapshot price at time of order
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([productId])
}

// ============================================
// PAYMENTS (Ready for Stripe integration)
// ============================================
model Payment {
  id              String        @id @default(uuid())
  orderId         String
  parentId        String? // Who made the payment
  amount          Float
  currency        String        @default("USD")
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  provider        String? // "stripe", "mock", "cash"
  providerRef     String? // Stripe payment intent ID
  providerRawData Json? // Full Stripe response
  notes           String?
  processedAt     DateTime?
  createdBy       String // Admin or parent userId
  isDeleted       Boolean       @default(false) // SOFT DELETE - financial data
  deletedAt       DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  order  Order   @relation(fields: [orderId], references: [id], onDelete: Restrict)
  parent Parent? @relation(fields: [parentId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([parentId])
  @@index([status])
  @@index([createdAt])
  @@index([isDeleted])
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  CASH
  PAYPAL
  STRIPE
  MOCK
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// ============================================
// ADMISSIONS
// ============================================
model Admission {
  id                   String          @id @default(cuid())
  firstName            String
  lastName             String
  email                String
  phone                String
  dateOfBirth          DateTime
  sex                  Sex
  address              String
  parentName           String
  parentPhone          String
  parentEmail          String?
  position             String?
  notes                String?
  status               AdmissionStatus @default(PENDING)
  reviewedBy           String? // Admin userId
  reviewedAt           DateTime?
  reviewNotes          String?
  convertedToStudentId String? // Track if converted
  isDeleted            Boolean         @default(false)
  deletedAt            DateTime?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([isDeleted])
}

enum AdmissionStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  CONVERTED
}

// ============================================
// FILE STORAGE TRACKING
// ============================================
model FileUpload {
  id          String    @id @default(uuid())
  url         String
  filename    String
  mimeType    String
  sizeBytes   Int
  uploadedBy  String // userId
  entityType  String? // "product", "student", "coach"
  entityId    String? // Reference to entity
  provider    String    @default("cloudinary") // or "s3", "clerk"
  providerRef String? // Cloudinary public_id
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())

  @@index([entityType, entityId])
  @@index([uploadedBy])
  @@index([isDeleted])
}

// ============================================
// SHOP: Jersey Orders
// ============================================
enum JerseyOrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
}

model JerseyOrder {
  id            String            @id @default(uuid())
  userId        String
  customerName  String
  contactNumber String
  email         String
  shirtSize     String
  shortsSize    String
  socksSize     String
  jerseyName    String
  jerseyNumber  Int
  customLength  String?
  customWidth   String?
  customNotes   String?
  status        JerseyOrderStatus @default(PENDING)
  isDeleted     Boolean           @default(false)
  deletedAt     DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  user AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([isDeleted])
  @@index([createdAt])
}

// ============================================
// AUDIT & ACTIVITY LOGS
// ============================================
model ActivityLog {
  id          String   @id @default(uuid())
  action      String // "CREATE_STUDENT", "UPDATE_ORDER", "DELETE_COACH"
  performedBy String // userId
  targetType  String? // "Student", "Order", "Coach"
  targetId    String?
  details     Json? // Flexible metadata
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  user AppUser @relation(fields: [performedBy], references: [id], onDelete: Cascade)

  @@index([performedBy])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// ============================================
// CLERK WEBHOOK SYNC LOG
// ============================================
model ClerkSyncLog {
  id          String   @id @default(uuid())
  clerkUserId String
  eventType   String // "user.created", "user.updated", "user.deleted"
  payload     Json
  status      String // "success", "failed", "pending"
  error       String?
  processedAt DateTime @default(now())

  @@index([clerkUserId])
  @@index([eventType])
  @@index([processedAt])
}

// ============================================
// FEE MANAGEMENT SYSTEM
// ============================================

enum FeeStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
  WAIVED
}

enum FeeFrequency {
  MONTHLY
  QUARTERLY
  YEARLY
  ONE_TIME
}

// Fee Plans - Define different types of fees
model FeePlan {
  id          String       @id @default(uuid())
  name        String       // e.g., "Monthly Academy Fee", "Tournament Fee"
  description String?
  amount      Float        // Base fee amount
  frequency   FeeFrequency @default(MONTHLY)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  feeRecords PlayerFeeRecord[]

  @@index([isActive])
  @@map("fee_plans")
}

// Player Fee Records - Individual fee instances for each player
model PlayerFeeRecord {
  id         String    @id @default(uuid())
  playerId   String
  feePlanId  String
  month      Int       // 1-12
  year       Int       // 2024, 2025, etc.
  amount     Float     // Total amount due
  paidAmount Float     @default(0) // Amount paid so far
  status     FeeStatus @default(UNPAID)
  dueDate    DateTime
  notes      String?
  isDeleted  Boolean   @default(false)
  deletedAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  player   Student      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  feePlan  FeePlan      @relation(fields: [feePlanId], references: [id])
  payments FeePayment[]

  @@unique([playerId, feePlanId, month, year])
  @@index([playerId])
  @@index([status])
  @@index([month, year])
  @@index([dueDate])
  @@index([isDeleted])
  @@map("player_fee_records")
}

// Fee Payments - Track individual payments against fee records
model FeePayment {
  id            String        @id @default(uuid())
  feeRecordId   String
  amount        Float
  paymentMethod PaymentMethod @default(CASH)
  paidAt        DateTime      @default(now())
  receivedBy    String        // Staff/Admin userId who recorded payment
  receiptNumber String?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  feeRecord PlayerFeeRecord @relation(fields: [feeRecordId], references: [id], onDelete: Cascade)

  @@index([feeRecordId])
  @@index([paidAt])
  @@map("fee_payments")
}

// Legacy MonthlyFee model (keeping for backward compatibility)
model MonthlyFee {
  id         String    @id @default(uuid())
  studentId  String
  parentId   String
  amount     Float
  month      Int       // 1-12
  year       Int       // 2024, 2025, etc.
  status     FeeStatus @default(UNPAID)
  dueDate    DateTime
  paidAt     DateTime?
  paidAmount Float?
  notes      String?
  isDeleted  Boolean   @default(false)
  deletedAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parent  Parent  @relation(fields: [parentId], references: [id], onDelete: Cascade)

  @@unique([studentId, month, year])
  @@index([parentId])
  @@index([status])
  @@index([dueDate])
  @@index([month, year])
  @@index([isDeleted])
}

// ============================================
// EMAIL LOGS
// ============================================
model EmailLog {
  id        String   @id @default(uuid())
  type      String   // "announcement", "news", "attendance", "fee", "admission", "order"
  recipient String   // email address
  subject   String
  body      String   @db.Text
  status    EmailStatus @default(PENDING)
  error     String?  @db.Text
  retryCount Int     @default(0)
  sentAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([recipient])
  @@index([sentAt])
  @@index([createdAt])
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}
